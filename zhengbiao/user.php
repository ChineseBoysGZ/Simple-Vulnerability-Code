<?php
session_start();
require_once('config.php');

if (!isset($_SESSION['user_id'])) {
  header('Location: index.php');
  exit();
}

$user_id = $_SESSION['user_id'];
$role = $_SESSION['role'];

if (isset($_POST['update'])) {
  $name = $_POST['name'];
  $id_card = $_POST['id_card'];
  $birth_date = $_POST['birth_date'];
  $nickname = $_POST['nickname'];
  $email = $_POST['email'];

  $sql = "UPDATE users SET name = '$name', id_card = '$id_card', birth_date = '$birth_date', nickname = '$nickname', email = '$email' WHERE id = $user_id";
  mysqli_query($conn, $sql);
}

$sql = "SELECT * FROM users WHERE id = $user_id";
$result = mysqli_query($conn, $sql);
$user = mysqli_fetch_assoc($result);

if ($role == 'admin') {
  $sql = "SELECT * FROM users";
  $all_users = mysqli_query($conn, $sql);
}
?>

<!DOCTYPE html>
<html>
<head>
  <title>User Information</title>
</head>
<body>
  <h1>User Information</h1>
  <p>ID: <?php echo $user['id']; ?></p>
  <p>UserName: <?php echo $user['username']; ?></p>

  <h2>Update Personal Information</h2>
  <form action="user.php" method="POST">
    <label for="name">Name:</label>
    <input type="text" name="name" value="<?php echo $user['name']; ?>">
    <br>
    <label for="id_card">ID Card:</label>
    <input type="text" name="id_card" value="<?php echo $user['id_card']; ?>">
    <br>
    <label for="birth_date">Birth Date:</label>
    <input type="date" name="birth_date" value="<?php echo $user['birth_date']; ?>">
    <br>
    <label for="nickname">Nickname:</label>
    <input type="text" name="nickname" value="<?php echo $user['nickname']; ?>">
    <br>
    <label for="email">Email:</label>
    <input type="email" name="email" value="<?php echo $user['email']; ?>">
    <br>
    <input type="submit" name="update" value="Update">
  </form>

  <?php if ($role == 'admin'): ?>
    <h2>All Users</h2>
    <table border="1">
      <tr>
        <th>ID</th>
        <th>Username</th>
        <th>Name</th>
        <th>ID Card</th>
        <th>Birth Date</th>
        <th>Nickname</th>
        <th>Email</th>
      </tr>
      <?php while ($row = mysqli_fetch_assoc($all_users)): ?>
        <tr>
          <td><?php echo $row['id']; ?></td>
          <td><?php echo $row['username']; ?></td>
          <td><?php echo $row['name']; ?></td>
          <td><?php echo $row['id_card']; ?></td>
          <td><?php echo $row['birth_date']; ?></td>
          <td><?php echo $row['nickname']; ?></td>
          <td><?php echo $row['email']; ?></td>
        </tr>
      <?php endwhile; ?>
    </table>
  <?php endif; ?>

  <form action="logout.php" method="POST">
    <input type="submit" name="logout" value="Logout">
  </form>
</body>
</html>
