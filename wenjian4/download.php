<?php
session_start();
require_once('config.php');

if (!isset($_SESSION['user_id'])) {
    header('Location: login.php');
    exit;
}

if (!isset($_GET['file_id'])) {
    die("Missing file ID.");
}

$file_id = intval($_GET['file_id']);
$sql = "SELECT * FROM files WHERE id = {$file_id}";
$result = mysql_query($sql, $conn);
$file = mysql_fetch_assoc($result);

if (!$file) {
    die("File not found.");
}

// 设置文件的路径和文件名
$file_path = $file['filepath'];
$file_name = $file['filename'];

// 检查文件是否存在
if (file_exists($file_path)) {
    // 设置 header 以提供下载
    header('Content-Description: File Transfer');
    header('Content-Type: application/octet-stream');
    header('Content-Disposition: attachment; filename="' . basename($file_name) . '"');
    header('Expires: 0');
    header('Cache-Control: must-revalidate');
    header('Pragma: public');
    header('Content-Length: ' . filesize($file_path));
    readfile($file_path);
    exit;
} else {
    die("File not found.");
}
