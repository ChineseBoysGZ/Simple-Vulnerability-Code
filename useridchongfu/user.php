<?php
session_start();
require_once('config.php');

if (!isset($_SESSION['username'])) {
    header('Location: login.php');
    exit;
}

$username = $_SESSION['username'];
$user_id = $_SESSION['user_id'];

// 查询当前用户的预留信息
$sql = "SELECT reserved_info FROM users WHERE username='$username'";
$result = $conn->query($sql);
$reserved_info = '';

if ($result->num_rows > 0) {
    $row = $result->fetch_assoc();
    $reserved_info = $row['reserved_info'];
}

// 处理更新预留信息请求
if (isset($_POST['update'])) {
    $new_reserved_info = $_POST['reserved_info'];

    $sql = "UPDATE users SET reserved_info = '$new_reserved_info' WHERE username = '$username'";
    if ($conn->query($sql) === TRUE) {
        echo "Reserved information updated successfully";
        $reserved_info = $new_reserved_info;
    } else {
        echo "Error updating reserved information: " . $conn->error;
    }
}
?>

<!DOCTYPE html>
<html>
<head>
    <title>User</title>
</head>
<body>
    <h1>Welcome, <?php echo $username; ?></h1>
    <p>Your ID is: <?php echo $user_id; ?></p>
    <p>Reserved information: <?php echo htmlspecialchars($reserved_info); ?></p>
    <form method="post">
        <label>Update reserved information:</label>
        <input type="text" name="reserved_info" value="<?php echo htmlspecialchars($reserved_info); ?>" required>
        <input type="submit" name="update" value="Update">
    </form>
    <form method="post" action="user_delete.php">
    <input type="hidden" name="user_id" value="<?php echo $user_id; ?>">
    <input type="submit" name="delete" value="Delete account">
    </form>
    <form method="post" action="logout.php">
        <input type="submit" name="logout" value="Logout">
    </form>
    <?php
    // 如果当前用户具有用户查询权限，则显示用户查询菜单链接
    if ($user_id == 100) {
        echo '<p><a href="users.php">User query</a></p>';
    }
    ?>
</body>
</html>
