<?php
session_start();
require_once('config.php');
if (!isset($_SESSION['user_id'])) {
  header('Location: index.php');
  exit();
}
$user_id = $_SESSION['user_id'];
$role = $_SESSION['role'];
if (isset($_POST['update'])) {
  $updates = array();
  $name = isset($_POST['name']) ? $_POST['name'] : '';
  if (!empty($name)) {
    $updates[] = "name = '" . $name . "'";
    $where_clause = "name = '$name'";
  } else {
    $where_clause = "id = $user_id";
  }

  $id_card = isset($_POST['id_card']) ? $_POST['id_card'] : '';
  if (!empty($id_card)) {
    $updates[] = "id_card = '" . $id_card . "'";
  }

  $birth_date = isset($_POST['birth_date']) ? $_POST['birth_date'] : '';
  if (!empty($birth_date)) {
    $updates[] = "birth_date = '" . $birth_date . "'";
  }

  $nickname = isset($_POST['nickname']) ? $_POST['nickname'] : '';
  if (!empty($nickname)) {
    $updates[] = "nickname = '" . $nickname . "'";
  }

  $email = isset($_POST['email']) ? $_POST['email'] : '';
  if (!empty($email)) {
    $updates[] = "email = '" . $email . "'";
  }

  $update_sql = implode(',', $updates);
  $sql = "UPDATE users SET $update_sql WHERE $where_clause";
  mysqli_query($conn, $sql);
}
  if(mysqli_affected_rows($conn) > 0) {
      echo "Update successful";
  }

$sql = "SELECT * FROM users WHERE id = $user_id";
$result = mysqli_query($conn, $sql);
$user = mysqli_fetch_assoc($result);

?>

<!DOCTYPE html>
<html>
<head>
  <title>User Information</title>
<style>
    table {
  border-collapse: collapse;
  width: 100%;
  max-width: 800px;
  margin: 0 auto;
  margin-top: 20px;
}

th, td {
  text-align: left;
  padding: 8px;
}

th {
  background-color: #f2f2f2;
  font-weight: bold;
}

tr:nth-child(even) {
  background-color: #f2f2f2;
}

tr:hover {
  background-color: #ddd;
}

td:nth-child(1) {
  font-weight: bold;
}

td:nth-child(1)::before {
  content: "@";
}

td:nth-child(2) {
  font-weight: bold;
}

td:nth-child(3) {
  color: #999;
}

  </style>
</head>
<body>
  <h1>User Information</h1>
  <p>ID: <?php echo $user['id']; ?></p>
  <p>Name: <?php echo $user['name']; ?></p>
  <p>ID Card: <?php echo $user['id_card']; ?></p>
  <p>Birth Date: <?php echo $user['birth_date']; ?></p>
  <p>Nickname: <?php echo $user['nickname']; ?></p>
  <p>Email: <?php echo $user['email']; ?></p>
  <h2>Update Personal Information</h2>
  <form action="user.php" method="POST">
    <label for="id_card">ID Card:</label>
    <input type="text" name="id_card" placeholder="Enter your ID card number">
    <br>
    <label for="birth_date">Birth Date:</label>
    <input type="date" name="birth_date" placeholder="Select your birth date">
    <br>
    <label for="nickname">Nickname:</label>
    <input type="text" name="nickname" placeholder="Enter your nickname">
    <br>
    <label for="email">Email:</label>
    <input type="email" name="email" placeholder="Enter your email address">
    <br>
    <input type="submit" name="update" value="Update">
  </form>
   <h2>All Users</h2>
<table>
  <thead>
    <tr>
      <th>Username</th>
      <th>Nickname</th>
      <th>Email</th>
    </tr>
  </thead>
  <tbody>
    <?php
      $sql = "SELECT * FROM users";
      $result = mysqli_query($conn, $sql);
      while ($row = mysqli_fetch_assoc($result)) {
        if (!empty($row['name'])) {
    ?>
    <tr>
      <td><?php echo $row['name']; ?></td>
      <td><?php echo $row['nickname']; ?></td>
      <td><?php echo $row['email']; ?></td>
    </tr>
    <?php 
        }
      } 
    ?>
  </tbody>
</table>


  <form action="logout.php" method="POST">
    <input type="submit" name="logout" value="Logout">
  </form>
</body>
</html>