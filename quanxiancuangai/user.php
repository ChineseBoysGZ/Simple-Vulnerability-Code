<?php
session_start();
require_once('config.php');

if (!isset($_SESSION['user_id'])) {
  header('Location: index.php');
  exit();
}

$user_id = $_SESSION['user_id'];
$role = $_SESSION['role'];

if (isset($_POST['update'])) {
  $updates = array();
  if (!empty($_POST['name'])) {
    $updates[] = "name = '" . $_POST['name'] . "'";
  }
  if (!empty($_POST['id_card'])) {
    $updates[] = "id_card = '" . $_POST['id_card'] . "'";
  }
  if (!empty($_POST['birth_date'])) {
    $updates[] = "birth_date = '" . $_POST['birth_date'] . "'";
  }
  if (!empty($_POST['nickname'])) {
    $updates[] = "nickname = '" . $_POST['nickname'] . "'";
  }
  if (!empty($_POST['email'])) {
    $updates[] = "email = '" . $_POST['email'] . "'";
  }
  if (isset($_POST['role'])) {
    $updates[] = "role = '" . $_POST['role'] . "'";
  }
  
  if (!empty($updates)) {
  $updates_str = implode(', ', $updates);
  $sql = "UPDATE users SET $updates_str WHERE id = $user_id";
  mysqli_query($conn, $sql);

  // 输出更新成功提示
  if (mysqli_affected_rows($conn) > 0) {
     echo 'Update successful';
  }
}
}

$sql = "SELECT * FROM users WHERE id = $user_id";
$result = mysqli_query($conn, $sql);
$user = mysqli_fetch_assoc($result);
?>


<!DOCTYPE html>
<html>
<head>
  <title>User Information</title>
</head>
<body>
  <h1>User Information</h1>
  <p>ID: <?php echo $user['id']; ?></p>
  <p>Name: <?php echo $user['name']; ?></p>
  <p>ID Card: <?php echo $user['id_card']; ?></p>
  <p>Birth Date: <?php echo $user['birth_date']; ?></p>
  <p>Nickname: <?php echo $user['nickname']; ?></p>
  <p>Email: <?php echo $user['email']; ?></p>
  <p>Role: <?php echo $user['role']; ?></p>

  <h2>Update Personal Information</h2>
  <form action="user.php" method="POST">
    <label for="id_card">ID Card:</label>
    <input type="text" name="id_card" placeholder="Enter your ID card number">
    <br>
    <label for="birth_date">Birth Date:</label>
    <input type="date" name="birth_date" placeholder="Select your birth date">
    <br>
    <label for="nickname">Nickname:</label>
    <input type="text" name="nickname" placeholder="Enter your nickname">
    <br>
    <input type="submit" name="update" value="Update">
  </form>

  <?php if ($role == 'admin'): ?>
  <h2>All Users</h2>
  <table border="1">
    <tr>
      <th>ID</th>
      <th>Username</th>
      <th>Name</th>
      <th>ID Card</th>
      <th>Birth Date</th>
      <th>Nickname</th>
      <th>Email</th>
    </tr>
    <?php
    $sql = "SELECT * FROM users";
    $result = mysqli_query($conn, $sql);
    while ($row = mysqli_fetch_assoc($result)) {
      echo "<tr>";
      echo "<td>{$row['id']}</td>";
      echo "<td>{$row['username']}</td>";
      echo "<td>{$row['name']}</td>";
      echo "<td>{$row['id_card']}</td>";
      echo "<td>{$row['birth_date']}</td>";
      echo "<td>{$row['nickname']}</td>";
      echo "<td>{$row['email']}</td>";
      echo "</tr>";
    }
    ?>
  </table>
<?php endif; ?>


  <form action="logout.php" method="POST">
    <input type="submit" name="logout" value="Logout">
  </form>
</body>
</html>