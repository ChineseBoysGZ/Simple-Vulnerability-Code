<?php
// index.php
session_start();
require_once 'config.php';

if (empty($_SESSION['user_id'])) {
    header('Location: login.php');
    exit;
}

// Add link
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $url = mysqli_real_escape_string($conn, $_POST['url']);
    $user_id = mysqli_real_escape_string($conn, $_SESSION['user_id']);

    $sql = "INSERT INTO links (url, user_id) VALUES ('$url', $user_id)";
    if (mysqli_query($conn, $sql)) {
        echo "Link added successfully.";
    } else {
        echo "Error adding link: " . mysqli_error($conn);
    }
}

// Delete link
if (isset($_GET['action']) && $_GET['action'] == 'delete' && isset($_GET['id'])) {
    $id = mysqli_real_escape_string($conn, $_GET['id']);
    $sql = "DELETE FROM links WHERE id = $id";
    if (mysqli_query($conn, $sql)) {
        echo "Link deleted successfully.";
    } else {
        echo "Error deleting link: " . mysqli_error($conn);
    }
}

?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Link Sharing</title>
</head>
<body>
    <h1>Link Sharing</h1>
    <p>Welcome, <?php echo htmlspecialchars($_SESSION['username']); ?>!</p>
    <form action="index.php" method="post">
        <label for="url">URL:</label>
        <input type="text" id="url" name="url" required>
        <br>
        <input type="submit" value="Share">
    </form>
    <h2>Shared Links</h2>
    <ul>
        <?php
        $sql = "SELECT * FROM links ORDER BY created_at DESC";
        $result = mysqli_query($conn, $sql);
        while ($row = mysqli_fetch_assoc($result)) {
            echo '<li><a href="' . htmlspecialchars($row['url']) . '">' . htmlspecialchars($row['url']) . '</a>';
            if ($row['user_id'] == $_SESSION['user_id']) {
                echo ' <a href="?action=delete&id=' . $row['id'] . '">Delete</a>';
            }
            echo '</li>';
        }
        ?>
    </ul>
    <a href="logout.php">Logout</a>
</body>
</html>
