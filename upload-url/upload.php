<?php
$upload_path = 'uploads/';

if (isset($_POST['data_uri']) && isset($_POST['filename'])) {
    $data_uri = $_POST['data_uri'];
    $filename = $_POST['filename'];

    // 提取文件扩展名
    $file_ext_from_filename = pathinfo($filename, PATHINFO_EXTENSION);

    // 检查文件扩展名是否在白名单中
    $allowed_ext = array('png', 'jpg', 'gif');
    if (!in_array($file_ext_from_filename, $allowed_ext)) {
        $response = array(
            'status' => 'error',
            'message' => 'Invalid file type! Only png, jpg, and gif are allowed.'
        );
    } else {
        // 提取文件扩展名
        preg_match('/data:image\/(.*?);base64/', $data_uri, $matches);
        $file_ext_from_data_uri = $matches[1];

        // 解码base64数据流
        $data = base64_decode(preg_replace('#^data:image/\w+;base64,#i', '', $data_uri));

        // 生成文件名
        $new_filename = rand(10, 99) . date("YmdHis") . "." . $file_ext_from_data_uri;

        // 保存文件到指定目录
        file_put_contents($upload_path . $new_filename, $data);

        // 构建响应信息
        $response = array(
            'status' => 'success',
            'message' => 'File uploaded successfully!',
            'file_path' => $upload_path . $new_filename,
            'file_name' => $new_filename,
        );
    }
} else {
    $response = array(
        'status' => 'error',
        'message' => 'No file received!'
    );
}

header('Content-Type: application/json');
echo json_encode($response);